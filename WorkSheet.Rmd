---
title: "Race_ITA"
author: "Nikita Tkachenko"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE )
```
```{r}
library(tidyverse)
library(tidymodels)
library(visdat)
```
```{r}
imagefilenames <- readxl::read_xlsx("data/imagefilnames.xlsx")
survey <- read.csv("data/Nigeria Colorism Survey Postcard_May 8, 2022_11.51.csv", stringsAsFactors = F)
itadata <- read.csv("data/fairface-ita.csv", stringsAsFactors = F, header = F,col.names = c("id","ita"))
image_panel <- read.csv("data/image_panel.csv", header = F, col.names = c("V1","V2","V3"))

```

```{r}
#Remove all rows without consent, Remove Survey Previews
survey_clean <- survey %>% filter(X1_Id != "") %>% filter(Status != "Survey Preview") %>% filter(Finished != F) %>% slice(-c(1,2)) %>% select(-c("Q24","Q26"))

# Collect choice from main questions
answers <- survey_clean %>% select(ResponseId, contains(c("_Management","_Marriage","_Politics"))) %>% pivot_longer(-ResponseId) %>% mutate(value = na_if(x = value, y = "")) %>% drop_na()%>% mutate(answer_id = row_number())

# Clean up the strings
answers <- answers %>% separate(name, c("Q_n","Type"), sep = "_") %>% mutate(Q_n = as.double(str_remove_all(Q_n,"X"))) %>% mutate(Type = str_sub(Type,1,nchar(Type)-1)) %>% mutate(Choice = as.double(str_sub(value, start = -1))) %>% select(-value)

# Replace all emtry strings with NA
survey_clean <- survey_clean %>% mutate(across(everything(), ~na_if(.,""))) 

# Collect Data from columns on Demographics and meta data
# which(colnames(survey_clean)=="Q24") #29
meta_and_demographics <- survey_clean[,seq(1,which(colnames(survey_clean)=="Demography5"))]

demography <- survey_clean %>% select(ResponseId, Q21, starts_with("Demography"))
#which(colnames(survey_clean)=="Q21") #24
meta_data <- survey_clean[,seq(1,which(colnames(survey_clean)=="X1_Type"))]                                
#survey_clean %>% anti_join(a, by = "ResponseId") %>% mutate(across(everything(), ~na_if(.,""))) %>%is.na() %>% colSums() == 55 %>% sort()

# Create Table with Image Information
# !!!! Assumed each column is continuation of a previous one !!!!
# image_panel_long <- image_panel %>% select(url = V1) %>% 
#   bind_rows(image_panel %>% select(url = V2),
#             image_panel %>% select(url = V3)) %>%
# mutate(Q_n = row_number())
# !!! Assumed each column is a choice
image_panel_long <- image_panel %>% mutate(Q_n = row_number()) %>% pivot_longer(-Q_n, names_to = "Choice_n", values_to = "url") %>% mutate(Choice_n = as.double(str_sub(Choice_n, start=-1)))

# Extract id from itadata
ita_data_clean <- itadata %>% mutate(id = str_remove_all(id, pattern = "train/")) %>% mutate(id = as.double(str_remove_all(id,pattern = ".jpg")))

# Merge them all together #There was a duplicate in imagefilenames kinda ruined stuff a bit
image_info <- imagefilenames %>% distinct() %>% left_join(image_panel_long, by = "url") %>% left_join(ita_data_clean, by = c("filename" = "id")) %>% mutate(Gender = case_when(
  Gender == "Male" ~ "Man",
  Gender == "Female" ~ "Woman"
))

# Build the complete DS
data_set <- answers %>% left_join(image_info, by = "Q_n")

# Show the one picked
data_set <- data_set %>% mutate(Selected = as.double(Choice_n == Choice))
data_set_full <- data_set %>% left_join(demography, by = "ResponseId")

# Clean up same sex marriage questions
what_to_remove <- data_set_full %>% select(answer_id, Q_n, Type, Gender, Choice_n, Demography2, Demography3) %>% 
pivot_wider(names_from = Choice_n, values_from = Gender) %>% 
  mutate(same = (Demography2 == `2`) + (Demography2 == `3`) + (Demography2 == `1`)) %>% 
  mutate(remove = 
           ((same > 0 & Demography3 == "Straight or heterosexual")|
           (same < 3 & Demography3 %in% c("Queer","Gay or homosexual","Lesbian"))|
           (Demography3 %in% c("Not listed, please specify","Bisexual","Asexual","NA")))&
           Type == "Marriage")

remove_id <- what_to_remove %>% select(c("answer_id","remove")) %>% filter(remove == T) %>% pull(answer_id)

# Remove the selected
`%notin%` <- Negate(`%in%`)

# Costed around 4k rows (painful NGL, if you can come up with how to later clean up comparison pairs, it would save around 2k, i guess)
data_set_full <- data_set_full %>% filter(answer_id %notin% remove_id) %>% rename(Subj_sex = Demography2, Subj_gender = Demography3, Age = Q21)

```


```{r mlogit}
data <- data_set_full %>% select(-c(Choice,url,filename, Demography4, Demography5)) %>% distinct(.keep_all = TRUE) %>% arrange(ResponseId,answer_id,Choice_n,Q_n)

# Rearrange_data
data <-  data %>% relocate(c("answer_id","Choice_n","Selected"), .after = ResponseId)
# Replace answer_id with question_n
data <- data %>% group_by(ResponseId) %>% mutate(Quest_n = rep(1:(n()/3), times = 1, length.out = NA, each = 3)) %>% select(-answer_id) %>% relocate(Quest_n, .before = Choice_n)

data
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
